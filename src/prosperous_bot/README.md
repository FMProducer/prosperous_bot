# Prosperous Bot: BTC-Neutral Rebalancer Tools ![coverage](https://img.shields.io/endpoint?url=https://sonarcloud.io/api/project_badges/measure?project=trading-ai-agent&metric=coverage)

## 1. Overview

This document describes the tools used for backtesting and optimizing a BTC-Neutral Rebalancing strategy for Prosperous Bot. The core idea of the strategy is to maintain a target allocation across different BTC-related assets (e.g., BTC Spot, BTC leveraged long, BTC leveraged short) and USDT, rebalancing periodically or when allocations deviate significantly from targets. The "neutral" aspect implies that the combined exposure aims to reduce directional BTC risk while capturing opportunities from volatility, funding rates (not yet implemented in backtester), or other factors.

**Tools:**

*   **`rebalance_backtester.py`**: This script simulates the rebalancing strategy on historical market data. It applies configured parameters like target asset weights, rebalance thresholds, commission rates, slippage, and risk controls (circuit breaker, safe mode) to generate detailed performance reports.
*   **`rebalance_optimizer.py`**: This script uses the Optuna hyperparameter optimization framework to find the best set of parameters for the rebalancing strategy by running multiple backtests with different parameter combinations.

Both scripts now primarily use a **unified configuration file** (typically `config/unified_config.json` or an example like `config/unified_config.example.json`) for all settings.

## 2. Directory Structure

A typical directory structure for using these tools would be:

```
prosperous_bot_project/
├── src/
│   └── prosperous_bot/
│       ├── rebalance_backtester.py
│       ├── rebalance_optimizer.py
│       └── README.md  <-- This file
├── config/
│   └── unified_config.example.json  <-- Main configuration file
├── data/
│   └── BTCUSDT_default_1h.csv
├── reports/
│   ├── backtest_YYYYMMDD_HHMMSS/      <-- Output from rebalance_backtester.py
│   │   ├── summary.csv
│   │   ├── trades.csv
│   │   └── equity.html
│   └── optimizer_run_YYYYMMDD_HHMMSS/ <-- Output from rebalance_optimizer.py
│       ├── optimization_log.csv
│       ├── best_params.json
│       ├── optimization_history.html
│       ├── param_importances.html
│       ├── slice_plot.html
│       └── contour_plot.html        <-- (if applicable)
│       └── trials/                  <-- (Optional, if trial reports are enabled)
│           └── trial_NUM_TIMESTAMP/
└── venv/  <-- (optional Python virtual environment)
```

*   **`src/prosperous_bot/`**: Contains the Python scripts.
*   **`config/`**: Holds the main `unified_config.example.json`. The scripts will generate this example if it's not found when they are first run with a path to a non-existent config file.
*   **`data/`**: Intended for input historical market data (e.g., `BTCUSDT_default_1h.csv`).
*   **`reports/`**: Default parent directory for all output reports. Each script run creates a unique timestamped sub-directory. Optimizer trial reports, if enabled, go into a `trials` subfolder within the optimizer run's directory.

## 3. Input Data (e.g., `data/BTCUSDT_default_1h.csv`)

*   **Source:** The historical market data is provided in a CSV file. The path to this file is specified in the `data_settings.csv_file_path` parameter within the `backtest_settings` section of the `unified_config.json`.
*   **Update Mechanism:** `signal_bot.py` is responsible for fetching and updating this data.
*   **Required Columns:** The CSV file *must* contain columns for timestamp, open, high, low, close, and volume. The exact names for these columns are configurable in `data_settings.ohlc_cols`, `data_settings.timestamp_col`, and `data_settings.volume_col`.
*   **Data Frequency:** The tools can work with various candle frequencies. The `annualization_factor` in financial ratio calculations might need adjustment based on the data's period if the default (252, for daily-like) is not appropriate.

## 4. Unified Configuration (`config/unified_config.example.json`)

This single JSON file is now the primary way to configure both the backtester and the optimizer. It contains two main sections: `optimizer_settings` and `backtest_settings`.
An example file, `config/unified_config.example.json` (using BTC assets), is generated by the scripts if the specified config file is not found.

### 4.1. `optimizer_settings` Section

This section controls the Optuna optimization process.

```json
{
  "optimizer_settings": {
    "n_trials": 100,
    "metric_to_optimize": "sharpe_ratio",
    "direction": "maximize",
    "sampler_type": "TPE",
    "pruner_type": "MedianPruner",
    "optimization_space": [
      {
        "path": "rebalance_threshold",
        "type": "float",
        "low": 0.005,
        "high": 0.1,
        "step": 0.001,
        "log": false 
      },
      {
        "path": "circuit_breaker_config.threshold_percentage",
        "type": "float",
        "low": 0.02,
        "high": 0.1
      },
      {
        "path": "data_settings.price_col_for_rebalance",
        "type": "categorical",
        "choices": ["open", "close"]
      },
      {
        "path": "target_weights_normal.BTC_SPOT", 
        "type": "float",
        "low": 0.1,
        "high": 0.8 
      }
      // ... more parameters to optimize
    ]
  },
  "backtest_settings": {
    // ... see section 4.2 ...
  }
}
```

**Parameters Explained:**

*   `n_trials` (integer): Number of optimization trials Optuna should run. Can be overridden by CLI argument in `rebalance_optimizer.py`.
*   `metric_to_optimize` (string): The key of the metric from the backtester's results to optimize (must be one of the `snake_case` keys from `summary.csv`).
    *   **Note on `max_drawdown_percent`**: To optimize for minimizing drawdown (e.g., a drawdown of -5% is better than -10%), you should set `direction: "maximize"` for this metric, as the goal is to make the (negative) drawdown value as close to zero as possible.
*   `direction` (string): "maximize" or "minimize", depending on whether higher or lower values of `metric_to_optimize` are better.
*   `sampler_type` (string, optional): The Optuna sampler to use (e.g., "TPE" (default), "Random", "CMAES"). If omitted or invalid, TPE is used.
*   `pruner_type` (string, optional): The Optuna pruner to use (e.g., "MedianPruner" (default), "Hyperband", "SuccessiveHalving"). If omitted or invalid, MedianPruner is used.
*   **`optimization_space`** (array of objects): This is crucial. Each object defines a parameter from `backtest_settings` that Optuna should optimize.
    *   `path` (string): Dot-separated path to the parameter within `backtest_settings`.
        *   Examples: `"rebalance_threshold"`, `"circuit_breaker_config.threshold_percentage"`, `"target_weights_normal.BTC_SPOT"`, `"data_settings.price_col_for_rebalance"`.
    *   `type` (string): The type of parameter. Supported types:
        *   `"float"`: For floating-point numbers.
        *   `"int"`: For integers.
        *   `"categorical"`: For values chosen from a predefined list.
    *   `low` (number): Lower bound of the range for `float` and `int` types.
    *   `high` (number): Upper bound of the range for `float` and `int` types.
    *   `step` (number, optional): The step size for `float` or `int` types.
    *   `log` (boolean, optional, default `false`): If `true` for `float` or `int`, Optuna suggests values on a logarithmic scale.
    *   `choices` (array, required for `categorical` type): An array of possible values (e.g., `["open", "close"]`).
    *   **Note on Optimizing Target Weights:** When optimizing individual asset weights within `target_weights_normal` or `target_weights_safe` (e.g., `path: "target_weights_normal.BTC_SPOT"`), be mindful of the sum of all weights. The system will update the specified individual weight(s). If the sum of weights is critical for your strategy (e.g., needing to sum to 1.0), you may need to handle normalization separately or adjust other weights accordingly in your analysis of the results. The backtester will use the weights as provided after optimization.


### 4.2. `backtest_settings` Section

This section contains all parameters needed to define a single backtest run. It's used directly by `rebalance_backtester.py` (when run standalone) and serves as the base template for `rebalance_optimizer.py` (which overrides values based on `optimization_space`).

```json
{
  // ... optimizer_settings ...
  "backtest_settings": {
    "initial_capital": 10000.0,
    "commission_taker": 0.0005,
    "commission_maker": 0.0002,
    "use_maker_fees_in_backtest": false,
    "slippage_percent": 0.0005,
    "annualization_factor": 252.0,
    "min_rebalance_interval_minutes": 60,
    "rebalance_threshold": 0.02,
    "target_weights_normal": {
      "BTC_SPOT": 0.65, 
      "BTC_LONG5X": 0.11,
      "BTC_SHORT5X": 0.24
    },
    "circuit_breaker_config": {
      "enabled": true,
      "threshold_percentage": 0.07,
      "lookback_candles": 1,
      "movement_calc_type": "(high-low)/open"
    },
    "safe_mode_config": {
      "enabled": true,
      "metric_to_monitor": "margin_usage",
      "entry_threshold": 0.70,
      "exit_threshold": 0.60,
      "target_weights_safe": {
        "BTC_SPOT": 0.75,
        "BTC_LONG5X": 0.05,
        "BTC_SHORT5X": 0.05,
        "USDT": 0.15 
      }
    },
    "data_settings": {
      "csv_file_path": "data/BTCUSDT_default_1h.csv",
      "timestamp_col": "timestamp",
      "ohlc_cols": { "open": "open", "high": "high", "low": "low", "close": "close" },
      "volume_col": "volume",
      "price_col_for_rebalance": "close"
    },
    "date_range": { 
      "start_date": "2022-01-01T00:00:00Z", 
      "end_date": "2023-12-31T23:59:59Z" 
    },
    "logging_level": "INFO",
    "report_path_prefix": "./reports/",
    "generate_reports_for_optimizer_trial": false 
  }
}
```

**Parameters Explained:**

*   `initial_capital` (float): Starting portfolio value in USDT.
*   `commission_taker` (float): Taker commission rate (e.g., 0.0005 for 0.05%).
*   `commission_maker` (float): Maker commission rate (e.g., 0.0002 for 0.02%).
*   `use_maker_fees_in_backtest` (boolean): If `true`, `maker_commission_rate` is used; otherwise, `taker_commission_rate`.
*   `slippage_percent` (float): Slippage applied to trades (e.g., 0.0005 for 0.05%).
*   `annualization_factor` (float): Factor to annualize metrics like Sharpe/Sortino (e.g., 252 for daily data).
*   `min_rebalance_interval_minutes` (integer): If set to a value > 0, rebalancing checks are only performed if this many minutes have passed since the last rebalance attempt. A value of 0 (or if the parameter is not set/is null) allows rebalancing checks on every candle, subject to other conditions like the Circuit Breaker.
*   `rebalance_threshold` (float): Deviation from target weights that triggers rebalancing (e.g., 0.01 for 1%).
*   `target_weights_normal` (object): Asset allocation targets for "NORMAL_MODE" using BTC-based assets.
*   **`circuit_breaker_config`** (object):
    *   `enabled` (boolean): Whether the circuit breaker is active.
    *   `threshold_percentage` (float): Max candle movement `(high-low)/open` before triggering (e.g., 0.10 for 10%).
    *   `lookback_candles` (integer): (Currently fixed at 1 in implementation) Number of candles to consider for movement.
    *   `movement_calc_type` (string): (Currently fixed at `(high-low)/open`) How candle movement is measured.
*   **`safe_mode_config`** (object):
    *   `enabled` (boolean): Whether safe mode is active.
    *   `metric_to_monitor` (string): (Currently fixed to "margin_usage") Metric used for safe mode triggers.
    *   `entry_threshold` (float): Threshold of the monitored metric to enter safe mode (e.g., 0.70 for 70% margin usage).
    *   `exit_threshold` (float): Threshold to exit safe mode (e.g., 0.50 for 50% margin usage).
    *   `target_weights_safe` (object): Asset allocation targets for "SAFE_MODE" using BTC-based assets.
    *   **Note on Margin Usage Calculation:** In the backtester, `margin_usage_ratio` is calculated as `used_margin_usdt / nav`, where `used_margin_usdt` is `(value_of_long_exposure_usdt / 5) + (value_of_short_exposure_usdt / 5)` (assuming 5x leverage for both legs as per the current simplified model). `nav` is the total portfolio equity. Triggering high margin usage typically requires either very high allocations to leveraged assets or significant NAV reduction while leveraged exposure is maintained.
*   **`data_settings`** (object):
    *   `csv_file_path` (string): Path to the historical market data CSV (e.g., `"data/BTCUSDT_default_1h.csv"`). Can be overridden by CLI argument in `rebalance_optimizer.py`.
    *   `timestamp_col` (string): Name of the timestamp column.
    *   `ohlc_cols` (object): Mapping for open, high, low, close column names.
    *   `volume_col` (string): Name of the volume column.
    *   `price_col_for_rebalance` (string): Price column ('open' or 'close') to use for rebalancing decisions and P&L calculations.
*   **`date_range`** (object, optional):
    *   `start_date` (string, optional): Start date for backtest (ISO 8601 format, e.g., "YYYY-MM-DDTHH:MM:SSZ"). If null or omitted, uses data start.
    *   `end_date` (string, optional): End date for backtest. If null or omitted, uses data end.
*   `logging_level` (string): Logging level (e.g., "INFO", "DEBUG", "WARNING").
*   `report_path_prefix` (string): Base path for saving reports. The optimizer will create a main run folder here, and individual trial reports (if enabled) will be in a "trials" subfolder. Standalone backtester runs will append "backtest_TIMESTAMP" to this prefix.
*   `generate_reports_for_optimizer_trial` (boolean, optional, default `false`): Specific to optimizer context. If `true` when `rebalance_optimizer.py` calls `rebalance_backtester.py`, individual backtest reports for that trial will be saved.

## 5. How to Run Scripts

Ensure you have Python installed and the required libraries (see Dependencies). It's recommended to use a virtual environment.
Scripts should generally be run from the root of the `prosperous_bot_project` directory using the `python -m src.prosperous_bot.<script_name>` module execution style for robust import handling.

### 5.1. `rebalance_backtester.py`

This script runs a single backtest using settings from the `backtest_settings` section of a unified configuration file.

**Command-line Arguments:**
*   `--config_file`: Path to the unified JSON configuration file.

**Example Command:**
```bash
python -m src.prosperous_bot.rebalance_backtester --config_file config/unified_config.example.json
```
(If the specified config file is not found, the script will attempt to create a `config/dummy_unified_config_for_backtester.json` and a corresponding dummy data file, then exit, prompting you to run with the new dummy config.)

### 5.2. `rebalance_optimizer.py`

This script runs multiple backtests to find optimal parameters using settings from a unified configuration file.

**Command-line Arguments:**
*   `--config_file`: Path to the unified JSON configuration file.
    *   The optimizer uses `optimizer_settings` for controlling the optimization process and `backtest_settings` as a template for each trial.
*   `--n_trials` (int, optional): Overrides `optimizer_settings.n_trials` from the config file.
*   `--data_file_path` (str, optional): Overrides `backtest_settings.data_settings.csv_file_path` from the config file.

**Example Command:**
```bash
python -m src.prosperous_bot.rebalance_optimizer --config_file config/unified_config.example.json --n_trials 50 --data_file_path data/BTCUSDT_alternative_data.csv
```
(If the specified config file is not found, the script will attempt to create a `config/unified_config.example.json` and a corresponding dummy data file, then exit, prompting you to run with the new dummy config.)

## 6. Output Files / Report Structure
(Content is largely the same as before, ensure it aligns with the new output directory structure for optimizer)

### 6.1. Backtester Output (e.g., `reports/backtest_YYYYMMDD_HHMMSS/`)
*(Path constructed from `report_path_prefix` in `backtest_settings` + "backtest_TIMESTAMP")*

*   **`summary.csv`**: Contains KPIs and configuration parameters.
*   **`trades.csv`**: Detailed log of every simulated trade.
*   **`equity.html`**: Interactive Plotly chart of portfolio value.

### 6.2. Optimizer Output (e.g., `reports/optimizer_run_YYYYMMDD_HHMMSS/`)
*(Path constructed from `report_path_prefix` in `backtest_settings` (used as base) + "optimizer_run_TIMESTAMP")*

*   **`optimization_log.csv`**: Results for every Optuna trial.
*   **`best_params.json`**: Details of the best trial.
*   **Optuna Visualization HTML Files**.
*   **`trials/` subfolder (optional):** Contains individual backtest reports for each trial if `generate_reports_for_optimizer_trial` is `true`.

## 7. Interpretation of Results
(Content is largely the same as before)

## 8. Dependencies
(Content is largely the same as before)

```
