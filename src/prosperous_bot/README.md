# Prosperous Bot: BTC-Neutral Rebalancer Tools

## 1. Overview

This document describes the tools used for backtesting and optimizing a BTC-Neutral Rebalancing strategy for Prosperous Bot. The core idea of the strategy is to maintain a target allocation across different BTC-related assets (e.g., BTC Spot, BTC leveraged long, BTC leveraged short) and USDT, rebalancing periodically or when allocations deviate significantly from targets. The "neutral" aspect implies that the combined exposure aims to reduce directional BTC risk while capturing opportunities from volatility, funding rates (not yet implemented in backtester), or other factors.

**Tools:**

*   **`rebalance_backtester.py`**: This script simulates the rebalancing strategy on historical market data. It applies configured parameters like target asset weights, rebalance thresholds, commission rates, slippage, and risk controls (circuit breaker, safe mode) to generate detailed performance reports.
*   **`rebalance_optimizer.py`**: This script uses the Optuna hyperparameter optimization framework to find the best set of parameters for the rebalancing strategy by running multiple backtests with different parameter combinations.

## 2. Directory Structure

A typical directory structure for using these tools would be:

```
prosperous_bot_project/
├── src/
│   └── prosperous_bot/
│       ├── rebalance_backtester.py
│       ├── rebalance_optimizer.py
│       └── README.md  <-- This file
├── config/
│   ├── backtest_params_example.json
│   └── optimizer_params_example.json
├── data/
│   └── BTCUSDT_1h_data.csv
├── reports/
│   ├── backtest_YYYYMMDD_HHMMSS/      <-- Output from rebalance_backtester.py
│   │   ├── summary.csv
│   │   ├── trades.csv
│   │   └── equity.html
│   └── optimizer_YYYYMMDD_HHMMSS/    <-- Output from rebalance_optimizer.py
│       ├── optimization_log.csv
│       ├── best_params.json
│       ├── optimization_history.html
│       ├── param_importances.html
│       ├── slice_plot.html
│       └── contour_plot.html        <-- (if applicable)
└── venv/  <-- (optional Python virtual environment)
```

*   **`src/prosperous_bot/`**: Contains the Python scripts.
*   **`config/`**: Holds configuration files for the backtester and optimizer. Example files are usually generated by the scripts if not found.
*   **`data/`**: Intended for input historical market data.
*   **`reports/`**: Default parent directory for all output reports. Each run creates a unique timestamped sub-directory.

## 3. Input Data (`BTCUSDT_1h_data.csv`)

*   **Source:** The historical market data is typically provided in a CSV file (e.g., `BTCUSDT_1h_data.csv`).
*   **Update Mechanism:** As per general project information, `signal_bot.py` is responsible for fetching and updating this data from the exchange (e.g., Bybit). The backtester and optimizer consume this data.
*   **Required Columns:** The CSV file *must* contain the following columns:
    *   `timestamp`: Datetime of the candle (e.g., `2023-01-01 00:00:00`).
    *   `open`: Opening price of the candle.
    *   `high`: Highest price during the candle.
    *   `low`: Lowest price during the candle.
    *   `close`: Closing price of the candle.
    *   `volume`: Trading volume during the candle.
*   **Data Frequency:** The tools are designed to work with various candle frequencies (e.g., 1-hour, 5-minute, 1-day). Ensure the chosen frequency is consistent with the strategy's intended operation. The `annualization_factor` in financial ratio calculations might need adjustment based on the data's period if default (252, for daily-like) is not appropriate.

## 4. Configuration Files

### 4.1. Backtester Configuration (`config/backtest_params_example.json`)

This JSON file configures the `rebalance_backtester.py`. Example:
```json
{
  "target_weights": { "BTC_SPOT": 0.60, "BTC_LONG5X": 0.20, "BTC_SHORT5X": 0.20 },
  "rebalance_threshold": 0.01,
  "initial_portfolio_value_usdt": 10000.0,
  "taker_commission_rate": 0.0007,
  "maker_commission_rate": 0.0002,
  "use_maker_fees_in_backtest": false,
  "slippage_percentage": 0.0005,
  "report_path_prefix": "./reports/backtest_",
  "circuit_breaker_threshold_percent": 0.10,
  "margin_usage_safe_mode_enter_threshold": 0.70,
  "margin_usage_safe_mode_exit_threshold": 0.50,
  "safe_mode_target_weights": { "BTC_SPOT": 0.80, "BTC_LONG5X": 0.05, "BTC_SHORT5X": 0.15 },
  "risk_free_rate_annual": 0.0,
  "annualization_factor": 252
}
```

**Parameters Explained:**

*   `target_weights`: Dictionary defining the target allocation for each asset in "NORMAL_MODE". Values should sum to 1.0 if USDT is not explicitly part of this (as USDT becomes the remainder). If USDT is included, all should sum to 1.0.
    *   `BTC_SPOT`: Proportion of portfolio in Spot BTC.
    *   `BTC_LONG5X`: Proportion in a 5x leveraged BTC long position (value-based representation).
    *   `BTC_SHORT5X`: Proportion in a 5x leveraged BTC short position (value-based representation).
*   `rebalance_threshold`: The deviation (e.g., 0.01 for 1%) from target weights that triggers a rebalance.
*   `initial_portfolio_value_usdt`: Starting capital in USDT.
*   `taker_commission_rate`: Commission rate for trades assumed to be "taker" orders (e.g., 0.0007 for 0.07%).
*   `maker_commission_rate`: Commission rate for trades assumed to be "maker" orders (e.g., 0.0002 for 0.02%).
*   `use_maker_fees_in_backtest`: Boolean. If `true`, `maker_commission_rate` is used; otherwise, `taker_commission_rate` is used.
*   `slippage_percentage`: Simulates price slippage for trades (e.g., 0.0005 for 0.05%). For SPOT, it adjusts the execution price. For leveraged (value-based), it's an additional USDT cost.
*   `report_path_prefix`: Prefix for the output directory of this backtest run.
*   `circuit_breaker_threshold_percent`: If a single candle's movement `(high-low)/open` exceeds this (e.g., 0.10 for 10%), rebalancing is skipped for that candle.
*   `margin_usage_safe_mode_enter_threshold`: If (estimated leveraged position margin / NAV) exceeds this (e.g., 0.70 for 70%), the strategy enters "SAFE_MODE".
*   `margin_usage_safe_mode_exit_threshold`: If in "SAFE_MODE" and margin usage drops below this (e.g., 0.50 for 50%), it returns to "NORMAL_MODE".
*   `safe_mode_target_weights`: Dictionary defining target asset allocations when in "SAFE_MODE". Typically more conservative.
*   `risk_free_rate_annual`: Annual risk-free rate used for Sharpe/Sortino ratio calculations (e.g., 0.02 for 2%).
*   `annualization_factor`: Factor used to annualize Sharpe/Sortino ratios (e.g., 252 for daily data, sqrt(365\*24) for hourly data if aiming for daily-equivalent annualization). This depends on the input data frequency and how returns are calculated per period.

### 4.2. Optimizer Configuration (`config/optimizer_params_example.json`)

This JSON file configures `rebalance_optimizer.py`. Example:
```json
{
  "fixed_params": {
    "target_weights": { "BTC_SPOT": 0.60, "BTC_LONG5X": 0.20, "BTC_SHORT5X": 0.20 },
    "initial_portfolio_value_usdt": 10000.0,
    "taker_commission_rate": 0.0007,
    "use_maker_fees_in_backtest": false,
    "report_path_prefix": "./reports/optimizer_trial_reports/trial_",
    "generate_reports_for_optimizer_trial": false,
    "circuit_breaker_threshold_percent": 0.10,
    "margin_usage_safe_mode_enter_threshold": 0.70,
    "margin_usage_safe_mode_exit_threshold": 0.50,
    "safe_mode_target_weights": { "BTC_SPOT": 0.80, "BTC_LONG5X": 0.05, "BTC_SHORT5X": 0.15 }
  },
  "optimization_params": {
    "rebalance_threshold": {"type": "float", "low": 0.001, "high": 0.05, "log": true},
    "maker_commission_rate": {"type": "float", "low": 0.0001, "high": 0.0005},
    "slippage_percentage": {"type": "float", "low": 0.0001, "high": 0.001}
  },
  "optimizer_settings": {
    "metric_to_optimize": "sharpe_ratio",
    "direction": "maximize",
    "n_trials": 100,
    "study_name": "example_btc_rebalance_opt_sharpe",
    "timeout_seconds": null
  }
}
```

**Parameters Explained:**

*   **`fixed_params`**: These parameters are passed directly to the backtester and are *not* optimized. They are identical in structure to the backtester's configuration parameters.
    *   `generate_reports_for_optimizer_trial`: (boolean, optional, default `false`) If true, each Optuna trial will generate full backtest reports. Useful for debugging specific trials but significantly slows down optimization.
*   **`optimization_params`**: Defines the search space for parameters to be optimized by Optuna. Each key is a parameter name (must match a parameter accepted by `run_backtest`).
    *   `type`: "float" or "int".
    *   `low`: Lower bound of the search range.
    *   `high`: Upper bound of the search range.
    *   `log`: (boolean, optional, for "float" type) If `true`, uses a logarithmic scale for suggesting values, useful for parameters like rates or thresholds that vary over orders of magnitude.
    *   `step`: (float, optional, for "float" or "int" type) Defines the discrete step for the hyperparameter.
*   **`optimizer_settings`**: Configures the Optuna study itself.
    *   `metric_to_optimize`: (string) The key of the metric from the backtester's results to optimize (must be one of the `snake_case` keys listed below).
    *   `direction`: (string) "maximize" or "minimize".
    *   `n_trials`: (integer, optional, default in script is 100) Number of optimization trials to run.
    *   `study_name`: (string, optional) A name for the Optuna study.
    *   `timeout_seconds`: (integer, optional, default `null`) Maximum duration for the optimization study in seconds.

**Available `metric_to_optimize` Keys (from `rebalance_backtester.py` output):**
`run_id`, `strategy_name`, `date_range_start`, `date_range_end`, `initial_portfolio_value_usdt`, `final_portfolio_value_usdt`, `total_net_pnl_usdt`, `total_net_pnl_percent`, `max_drawdown_percent` (Note: higher is better, e.g., -5% is better than -10%), `sharpe_ratio`, `sortino_ratio`, `profit_factor`, `total_trades`, `winning_trades`, `losing_trades`, `win_rate_percent`, `average_trade_pnl_usdt`, `average_winning_trade_usdt`, `average_losing_trade_usdt`, `ratio_avg_win_avg_loss`, `total_commissions_usdt`, `total_slippage_usdt`, `num_circuit_breaker_triggers`, `num_safe_mode_entries`, `time_steps_in_safe_mode`.

## 5. How to Run Scripts

Ensure you have Python installed and the required libraries (see Dependencies). It's recommended to use a virtual environment.

### 5.1. `rebalance_backtester.py`

This script runs a single backtest with a given configuration.

**Command-line Arguments:**
*   `params_file`: Path to the backtester JSON configuration file.
*   `data_file`: Path to the input CSV market data file.

**Example Command:**
```bash
python src/prosperous_bot/rebalance_backtester.py config/backtest_params_example.json data/BTCUSDT_1h_data.csv
```
(If `config/backtest_params_example.json` or `data/BTCUSDT_1h_data.csv` do not exist, the script will attempt to create dummy versions for a quick test run.)

### 5.2. `rebalance_optimizer.py`

This script runs multiple backtests to find optimal parameters.

**Command-line Arguments:**
*   `--config_file`: Path to the optimizer JSON configuration file.
*   `--data_file`: Path to the input CSV market data file (used by the backtester in each trial).
*   `--n_trials`: (Optional) Number of optimization trials. Overrides `n_trials` in the config file if specified. Default: 100.
*   `--output_dir_prefix`: (Optional) Prefix for the optimizer's output directory. Default: `./reports/optimizer_`.

**Example Command:**
```bash
python src/prosperous_bot/rebalance_optimizer.py --config_file config/optimizer_params_example.json --data_file data/BTCUSDT_1h_data.csv --n_trials 50
```
(If `config/optimizer_params_example.json` or `data/BTCUSDT_1h_data.csv` (or a similarly named dummy file) do not exist, the script will attempt to create them for a quick test run.)

## 6. Output Files / Report Structure

All reports are saved into timestamped subdirectories within `./reports/`.

### 6.1. Backtester Output (e.g., `reports/backtest_YYYYMMDD_HHMMSS/`)

*   **`summary.csv`**: Contains key performance indicators (KPIs) and configuration parameters for the backtest run. Each row has a 'Metric' and 'Value'. Metrics include:
    *   `run_id`, `strategy_name`, date ranges.
    *   Initial and Final Portfolio Values, PnL (USDT and %).
    *   `max_drawdown_percent`: Largest peak-to-trough decline.
    *   `sharpe_ratio`, `sortino_ratio`: Risk-adjusted return metrics.
    *   `profit_factor`: Gross profit / gross loss from spot trades.
    *   Trade statistics: `total_trades`, `winning_trades`, `losing_trades`, `win_rate_percent`, average PnLs for spot trades.
    *   Costs: `total_commissions_usdt`, `total_slippage_usdt`.
    *   Risk control stats: `num_circuit_breaker_triggers`, `num_safe_mode_entries`, `time_steps_in_safe_mode`.
    *   Configuration parameters used for the run (e.g., `config_target_weights_normal`, `config_rebalance_threshold`).
*   **`trades.csv`**: Detailed log of every simulated trade. Columns include:
    *   `timestamp_open`, `timestamp_close`: Entry/exit time of the trade (for rebalancing, these are often the same).
    *   `asset_type`: (e.g., BTC_SPOT, BTC_LONG5X).
    *   `action`: BUY or SELL.
    *   `quantity_asset`: Amount of asset traded (BTC for spot, USDT value for leveraged).
    *   `quantity_quote`: USDT value of the trade before fees.
    *   `entry_price`, `exit_price`: Market prices.
    *   `commission_quote`: Commission paid in USDT.
    *   `slippage_quote`: Slippage cost in USDT.
    *   `pnl_gross_quote`: PnL before commission (primarily for BTC_SPOT trades from FIFO).
    *   `pnl_net_quote`: PnL after commission (primarily for BTC_SPOT trades).
*   **`equity.html`**: An interactive Plotly chart showing the portfolio value over time.

### 6.2. Optimizer Output (e.g., `reports/optimizer_YYYYMMDD_HHMMSS/`)

*   **`optimization_log.csv`**: A CSV file containing results for every Optuna trial. Columns include:
    *   `number`: Trial number.
    *   `value`: The value of the `metric_to_optimize` for that trial.
    *   `datetime_start`, `datetime_complete`, `duration`.
    *   `params_...`: Columns for each hyperparameter being optimized (e.g., `params_rebalance_threshold`).
    *   `state`: (e.g., COMPLETE, PRUNED, FAIL).
*   **`best_params.json`**: A JSON file detailing the best trial:
    *   `best_value`: The best score achieved for the `metric_to_optimize`.
    *   `best_params_suggested`: The specific hyperparameter values suggested by Optuna for the best trial.
    *   `full_config_for_best_trial`: A complete configuration dictionary (merging `fixed_params` and `best_params_suggested`) that can be used to run a backtest with the best found settings.
    *   `best_trial_number`: The trial number that achieved the best result.
*   **Optuna Visualization HTML Files (if Plotly is installed):**
    *   `optimization_history.html`: Shows the progression of the optimization metric over trials.
    *   `param_importances.html`: Visualizes the relative importance of each hyperparameter.
    *   `slice_plot.html`: Shows the relationship between individual hyperparameters and the objective value.
    *   `contour_plot.html`: (Generated if >1 parameter is optimized) Shows relationships between two hyperparameters and the objective value in a 2D contour map.

## 7. Interpretation of Results

### 7.1. Backtester `summary.csv` KPIs:
*   **PnL Metrics**: Indicate overall profitability.
*   **Max Drawdown**: Measures the largest loss from a peak; lower (less negative) is generally better.
*   **Sharpe/Sortino Ratios**: Higher values suggest better risk-adjusted returns. Sharpe uses total volatility; Sortino uses only downside volatility.
*   **Profit Factor**: Values > 1 indicate profitability from spot trades. Higher is better.
*   **Win Rate & Avg Win/Loss Ratio**: Provide insights into trade characteristics.
*   **Commissions & Slippage**: Show the impact of trading costs.
*   **Circuit Breaker/Safe Mode Stats**: Indicate how often risk controls were triggered and active.

### 7.2. Optuna Plots:
*   **Optimization History**: Look for a trend where the objective value improves (maximizes or minimizes) over trials and eventually plateaus, suggesting convergence towards good solutions.
*   **Parameter Importance**: Identifies which hyperparameters have the most significant impact on the objective value. Focus tuning efforts on these.
*   **Slice Plot**: Helps understand how the objective value changes as a single hyperparameter is varied, holding others constant. Reveals optimal ranges or sensitivities.
*   **Contour Plot**: Shows the interplay between two hyperparameters and how they jointly affect the objective. Useful for finding optimal combinations.

## 8. Dependencies

Key Python libraries required:
*   `pandas`
*   `plotly` (especially for Optuna visualizations and equity curve)
*   `optuna`

It's recommended to manage dependencies using a `requirements.txt` file and a Python virtual environment.
```

This `README.md` file should provide a comprehensive guide for users.The Optuna visualizations were added to `rebalance_optimizer.py` in the previous turn. The `README.md` file has just been created.

**Summary of Actions:**

1.  **Optuna Visualizations (in `rebalance_optimizer.py`):**
    *   Successfully integrated the generation of `plot_optimization_history`, `plot_param_importances`, `plot_slice`, and conditional `plot_contour` (if >1 parameter and importances are available or defaults to first two).
    *   Plots are saved as HTML files in the optimizer's output directory.
    *   Import errors for visualization libraries (like `plotly`) are handled gracefully, allowing the optimizer to run but skipping plot generation with a warning.

2.  **User Documentation (`src/prosperous_bot/README.md`):**
    *   A comprehensive `README.md` file has been created in `src/prosperous_bot/`.
    *   **Contents:**
        *   Overview of the strategy and tools.
        *   Expected directory structure.
        *   Input data requirements and update mechanism.
        *   Detailed explanations of configuration files for both the backtester (`backtest_params_example.json`) and optimizer (`optimizer_params_example.json`), including all parameters and example values. A list of available `metric_to_optimize` keys is provided.
        *   Clear instructions and example commands on how to run `rebalance_backtester.py` and `rebalance_optimizer.py`.
        *   Description of all output files generated by both tools, including `trades.csv`, `summary.csv`, `equity.html` for the backtester, and `optimization_log.csv`, `best_params.json`, and Optuna visualization HTML files for the optimizer.
        *   Guidance on interpreting backtester KPIs from `summary.csv` and understanding Optuna plots.
        *   A note on key dependencies.

**Conclusion:**
Both deliverables for this sub-task have been completed. The `rebalance_optimizer.py` script now includes robust generation of Optuna visualization plots, and a detailed `README.md` file has been created to guide users in understanding, configuring, and running the rebalancing tools.
